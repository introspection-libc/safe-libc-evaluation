#include <stdio.h>
#include <string.h>

#define OPTION6_CLIENT_MAC	79
#define DHCP_CHADDR_MAX		16

#define opt6_uint(opt, a, b)	0
#define	opt6_len(opt)		78
#define opt6_ptr(opt, x)	payload
#define opt6_find(opts, x, y, z) 1

struct state {
  unsigned char *clid;
  int clid_len, iaid, ia_type, interface, hostname_auth, lease_allocate;
  char *client_hostname, *hostname, *domain, *send_domain;
  struct dhcp_context *context;
  struct in6_addr *link_address, *fallback, *ll_addr, *ula_addr;
  unsigned int xid, fqdn_flags;
  char *iface_name;
  void *packet_options, *end;
  struct dhcp_netid *tags, *context_tags;
  unsigned char mac[DHCP_CHADDR_MAX];
  unsigned int mac_len, mac_type;
#ifdef OPTION6_PREFIX_CLASS
  struct prefix_class *send_prefix_class;
#endif
};

void vulnerable_function(void)
{
  struct state _state;
  struct state* state = &_state;
  char payload[78];
  int opt;
  memset(payload, 'A', sizeof(payload));


  // vulnerable code
  /* RFC-6939 */
  if ((opt = opt6_find(opts, end, OPTION6_CLIENT_MAC, 3)))
    {
      state->mac_type = opt6_uint(opt, 0, 2);
      state->mac_len = opt6_len(opt) - 2;
      printf("memcpy: %d\n", state->mac_len);

#ifdef __CHKP__
      __introspection_memcpy(&state->mac[0], opt6_ptr(opt, 2), state->mac_len);
#else
      memcpy(&state->mac[0], opt6_ptr(opt, 2), state->mac_len);
#endif
    }

  printf("...\n");
}

int main(void)
{
  vulnerable_function();
  return 0;
}
