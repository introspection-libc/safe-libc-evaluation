#!/bin/sh

SAFEC=$HOME/git/safec

compile_asan() {
	CLANG_PATH=$HOME/git/llvm-build/bin
	CFLAGS="-fsanitize=address -fno-common -fPIC -Wall -O3 -g -D_POSIX_C_SOURCE=200809L"
	LDFLAGS="-pie -Wl,-E -include $SAFEC/libc.h"
	$CLANG_PATH/clang $CFLAGS $LDFLAGS $SAFEC/libc-asan.o "$@"
}

compile_softboundcets() {
	CLANG_PATH=$HOME/git/softboundcets-3.8.0/llvm-38/build/bin
	CFLAGS="-fsoftboundcets -Wall -O3 -g"
	LDFLAGS="-fsoftboundcets -Wl,-E -L$HOME/git/softboundcets-3.8.0/runtime -include $SAFEC/libc.h"
	LIBS="$SAFEC/libc-softbound.o $SAFEC/softbound.c -lm -lrt -lsoftboundcets_rt"

	$CLANG_PATH/clang $CFLAGS -DNO_STACKTRACE -c -o $SAFEC/libc-softbound.o $SAFEC/libc.c
	$CLANG_PATH/clang $CFLAGS -c -o $SAFEC/softbound.o $SAFEC/softbound.c
	$CLANG_PATH/clang $CFLAGS $LDFLAGS "$@" $LIBS
}

compile_mpx() {
	CFLAGS="-mmpx -fcheck-pointer-bounds -fno-chkp-use-wrappers -O3 -g -lmpxwrappers"
	LDFLAGS="-Wl,--no-as-needed -Wall -W -O3 -g -lmpx -lmpxwrappers"
	LIBS="$SAFEC/libc-mpx.o $SAFEC/mpx.o"
	gcc $CFLAGS $LDFLAGS "$@" $LIBS
}

mkdir -p bin/asan
mkdir -p bin/mpx
mkdir -p bin/softbound

compile_softboundcets -o bin/softbound/dnsmasq-cve-2017-14493-code dnsmasq-cve-2017-14493-code.c
compile_softboundcets -o bin/softbound/dnsmasq-cve-2017-14496-code dnsmasq-cve-2017-14496-code.c
compile_softboundcets -o bin/softbound/graphicsmagick-cve-2017-16352 graphicsmagick-cve-2017-16352.c
compile_softboundcets -o bin/softbound/libxml2-cve-2017-9047 libxml2-cve-2017-9047.c
compile_softboundcets -o bin/softbound/lightftp-cve-2017-1000218 lightftp-cve-2017-1000218.c

compile_asan -o bin/asan/dnsmasq-cve-2017-14493-code dnsmasq-cve-2017-14493-code.c
compile_asan -o bin/asan/dnsmasq-cve-2017-14496-code dnsmasq-cve-2017-14496-code.c
compile_asan -o bin/asan/graphicsmagick-cve-2017-16352 graphicsmagick-cve-2017-16352.c
compile_asan -o bin/asan/libxml2-cve-2017-9047 libxml2-cve-2017-9047.c
compile_asan -o bin/asan/lightftp-cve-2017-1000218 lightftp-cve-2017-1000218.c

compile_mpx -o bin/mpx/dnsmasq-cve-2017-14493-code dnsmasq-cve-2017-14493-code.c
compile_mpx -o bin/mpx/dnsmasq-cve-2017-14496-code dnsmasq-cve-2017-14496-code.c
compile_mpx -o bin/mpx/graphicsmagick-cve-2017-16352 graphicsmagick-cve-2017-16352.c
compile_mpx -o bin/mpx/libxml2-cve-2017-9047 libxml2-cve-2017-9047.c
compile_mpx -o bin/mpx/lightftp-cve-2017-1000218 lightftp-cve-2017-1000218.c
